name: Auto Generate and Index New Posts

on:
  push:
    branches:
      - main # تأكد من أن هذا هو اسم الفرع الرئيسي لديك
    paths:
      - 'titles.txt' # تشغيل الـ Workflow عند تحديث ملف العناوين فقط
  workflow_dispatch: # يسمح بتشغيله يدوياً من واجهة Actions

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write # صلاحية الكتابة لـ GITHUB_TOKEN لعمل Push
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (requests)
        run: |
          pip install -r requirements.txt
          
      - name: Generate Article and Update Index
        env:
          # تمرير مفتاح API كمتغير بيئة للسكربت
          HF_TOKEN: ${{ secrets.HF_TOKEN }} 
        run: |
          echo "Starting article generation..."
          
          # 1. تشغيل سكربت التوليد (يقرأ من titles.txt ويحفظ في posts/)
          python generate_post.py

          echo "Starting index update..."
          
          # 2. تشغيل سكربت تحديث الفهرس (يقرأ posts/ ويحدث index.json)
          python update_index.py
          
          # 3. إعداد Git والإرسال (Push)
          git config user.name "Auto-Generator Action"
          git config user.email "actions@github.com"
          
          # إضافة جميع الملفات التي تم تغييرها (posts/, index.json, titles.txt, log.txt)
          git add posts/
          git add index.json
          git add titles.txt
          git add log.txt

          # 4. التحقق من وجود تغييرات لـ Commit
          if git status --porcelain | grep -q .; then
            echo "Changes detected. Committing and pushing..."
            git commit -m "🤖 Auto-generated post and updated index."
            git push
          else
            echo "No new changes. Skipping commit."
          fi
